<!doctype html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ad-Hockery - Gradle and Groovy’s Invoke Dynamic support</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/stylesheets/adhockery.css">
    <link rel="stylesheet" href="/stylesheets/prism.css">
    <script src="/javascripts/modernizr.custom.js"></script>
    <script src="//use.edgefonts.net/ultra;league-gothic.js"></script>
  </head>
  <body>

    <header>
      <h1 class="logo"><a href="/">Ad-Hockery</a></h1>
      <dl class="strapline">
        <dt>ad-hockery: <em>/ad·hok'@r·ee/</em>, n.</dt>
        <dd>Gratuitous assumptions... which lead to the appearance of semi-intelligent behavior but are in fact entirely arbitrary. <cite><a href="http://www.retrologic.com/jargon/A/ad-hockery.html">Jargon File</a></cite>
      </dl>
    </header>

    <div class="container">
      <main>
          <article>
    <header>
      <time datetime="2014-06-24T15:32:00">Jun 24 2014</time>
      <h1>Gradle and Groovy’s Invoke Dynamic support</h1>
    </header>
    <div class="paragraph">
<p>Since version 2.0 the Groovy distribution has included an alternate artifact that enables <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/vm/multiple-language-support.html#invokedynamic">invoke dynamic</a> support.</p>
</div>

<div class="paragraph">
<p>You can include that in a Gradle project by specifying a dependency like this:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">compile "org.codehaus.groovy:groovy-all:2.3.3:indy"</code></pre>
</div>
</div>
<div class="paragraph">
<p>However if you have other libraries that depend on groovy they may pull in the regular version transitively giving you two versions of Groovy in your dependency graph. This happens to me a lot with Spock which depends on <em>groovy-all:2.0.5</em>. For example I probably have a dependency like this as well:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">testCompile "org.spockframework:spock-core:0.7-groovy-2.0"</code></pre>
</div>
</div>
<div class="paragraph">
<p>I noticed that the <em>External Libraries</em> section of the project tree in <em>IntelliJ IDEA</em> contained two <em>groovy-all</em> jars. One is <em>groovy-all-2.3.3</em> and the other is <em>groovy-all-2.3.3-indy</em>. That&#8217;s not good. I only want the <em>indy</em> version.</p>
</div>
<div class="paragraph">
<p>To debug where the dependency is coming from you can use Gradle&#8217;s <code>dependencyInsight</code> target like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">gradle dependencyInsight --dependency groovy-all</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the <code>dependencyInsight</code> only searches the <em>compile</em> configuration and you may well see nothing there. You can search other configurations by adding an argument on the command line. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="bash language-bash">gradle dependencyInsight --dependency groovy-all --configuration testCompile</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from the command looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>:dependencyInsight
org.codehaus.groovy:groovy-all:2.3.3 (conflict resolution)
\--- compile

org.codehaus.groovy:groovy-all:2.0.5 -&gt; 2.3.3
\--- org.spockframework:spock-core:0.7-groovy-2.0
     \--- testCompile</pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see <em>groovy-all</em> version <em>2.3.3</em> explicitly included as a <em>compile</em> dependency <strong>and</strong> pulled in transitively by Spock. Gradle&#8217;s conflict resolution has selected version <em>2.3.3</em> but what the output doesn&#8217;t show us is the variant. It doesn&#8217;t appear to be possible to tell whether the <em>indy</em> or regular flavor of <em>groovy-all</em> is pulled in.</p>
</div>
<div class="paragraph">
<p>To fix this I first tried forcing the version with:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">configurations.all {
  resolutionStrategy {
    force "org.codehaus.groovy:groovy-all:2.3.3:indy"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>dependencyInsight</code> output changed a little:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>:dependencyInsight
org.codehaus.groovy:groovy-all:2.3.3 (forced)
\--- compile

org.codehaus.groovy:groovy-all:2.0.5 -&gt; 2.3.3
\--- org.spockframework:spock-core:0.7-groovy-2.0
     \--- testCompile</pre>
</div>
</div>
<div class="paragraph">
<p>However, I could still see both versions of <em>groovy-all</em> in IDEA&#8217;s project tree. It looks like the <em>force</em> resolution strategy doesn&#8217;t take into account the variant you request.</p>
</div>
<div class="paragraph">
<p>Unfortunately the only way to get evict the regular <em>groovy-all</em> jar from the dependency tree seems to be to explicitly exclude it from every dependency that pulls it in transitively. For example:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">testCompile("org.spockframework:spock-core:0.7-groovy-2.0") {
  exclude module: "groovy-all"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally the extra jar is gone from IDEA.</p>
</div>
    <footer>
      <ul class="tag-list">
          <li><a href="/tags/groovy/">groovy</a></li>
          <li><a href="/tags/gradle/">gradle</a></li>
          <li><a href="/tags/jdk7/">jdk7</a></li>
          <li><a href="/tags/invokedynamic/">invokedynamic</a></li>
      </ul>
    </footer>
  </article>

      </main>

      <footer>
        <nav>
          <a href="/">Home</a>
          <a href="/about">About</a>
          <a href="/archive">Archive</a>
        </nav>
      </footer>
    </div>

    <script src="/javascripts/adhockery.js"></script>
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-27275689-1', 'auto');
  ga('send', 'pageview');
</script>
  </body>
</html>

<footer class="disqus">
  <div id="disqus_thread"></div>
            <script type="text/javascript">
            //<![CDATA[
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//adhockery.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            //]]>
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </script>
</footer>
