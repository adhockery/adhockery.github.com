---
title: 'Grails plugins on Hudson'
date: 2010-03-11T17:50:00+0000
tags: continuous integration, hudson, grails plugins
alias: ["post/42902862201/grails-plugins-on-hudson/"]
---

image:http://4.bp.blogspot.com/_fh9xwLFYBUw/S5ks3ENs8yI/AAAAAAAACbU/vHE684-UsTI/s400/hudson.png[image]Yesterday I spent some time setting up http://hudson-ci.org/[Hudson] continuous integration build for my various Grails plugins. It was pretty straightforward but I've https://twitter.com/wangjammer5/statuses/10269319705[been asked] to document the steps involved.

Each plugin has one or more test applications under `test/projects` each of which has `grails.plugin.location.whatever = "../../.."` in `BuildConfig.groovy`. So each plugin CI build needs to run not only the plugin's own unit tests but any integration and/or functional tests included in the test apps as well.

[[hudson-plugins]]
Hudson plugins
~~~~~~~~~~~~~~

I installed the essential plugins I would need:

* The http://wiki.hudson-ci.org/display/HUDSON/Grails+Plugin[Grails plugin] makes building Grails projects much easier and allows you to build against multiple versions of Grails.
* The http://wiki.hudson-ci.org/display/HUDSON/Git+Plugin[Git plugin] enables Hudson to pull from a Git repository such as GitHub.
* The http://wiki.hudson-ci.org/display/HUDSON/Github+Plugin[GitHub plugin] adds links to the GitHub project in the Hudson build.
* The http://wiki.hudson-ci.org/display/HUDSON/ChuckNorris+Plugin[Chuck Norris plugin] encourages you to keep your tests from failing.

[[configuring-grails]]
Configuring Grails
~~~~~~~~~~~~~~~~~~

Under _Manage Hudson -> Configure System_ there is a _Grails Builder_ section where I entered the name and path of the various versions of Grails installed on the build box.

[[connecting-to-github]]
Connecting to GitHub
~~~~~~~~~~~~~~~~~~~~

In the project configuration:

* I pasted the GitHub project URL in the _Github project_ field (shown if you have the GitHub plugin installed).
* Under _Source Code Management_ I selected _Git_ then pasted the read-only repository URL into the _URL of repository_ field.
* I entered _master_ in the _Branch Specifier_ field as I've seen Hudson do odd things picking up changes from other branches before. I don't really need this behaviour and haven't had time to investigate it further yet.
* I ticked _Poll SCM_ under _Build Triggers_ then set a cron expression of `*/5 * * * *` so Hudson will poll GitHub every 5 minutes.

[[grails-build-steps]]
Grails build steps
~~~~~~~~~~~~~~~~~~

Select _Build with Grails_ from the _Add build step_ drop down, then:

* Select the _Grails Installation_ you want to use.
* Enter the _Targets_ to run. These are the Grails commands that Hudson will execute. For example, I entered `"test-app unit: -clean --non-interactive" package-plugin` for the to run unit tests then package the plugin. The quotes allow arguments to be passed to individual targets so I'm telling the _test-app_ phase to build clean and run non-interactively (i.e. Grails won't ask about things like installing or uninstalling plugins).
* The other fields can be left blank for now.

Add further Grails build steps for test applications. The only difference in configuring these is that the targets will likely be different and _Project Base Directory_ needs to be set to the relative path where the test apps lives, e.g. `test/projects/content-caching`
[[isolating-each-build]]
Isolating each build
~~~~~~~~~~~~~~~~~~~~

One thing I found is that it's probably a good idea to specify separate working directory for each build. I found that simultaneous builds would stomp over each other's compiled classes otherwise. This is particularly an issue for me where I have a build for the _Selenium RC_ plugin whilst one of the test apps for the _Springcache_ plugin uses the latest _Selenium RC_ release to run tests.

Hudson provides various http://wiki.hudson-ci.org/display/HUDSON/Building+a+software+project#Buildingasoftwareproject-HudsonSetEnvironmentVariables[environment variables] so I just set _grails.work.dir_ to `/tmp/.grails/${JOB_NAME}` in every case.

The other consideration is the port that Grails applications will use. If you are running any kind of functional tests the Grails application will start and it each Hudson job needs to use a separate server port or simultaneous jobs will experience port contention. The server port is also configured in the Grails build step. I've just assigned a different one to each job but I couldn't think of a particularly clever way to automate the port assignment.

[[test-reports]]
Test reports
~~~~~~~~~~~~

Under _Post-build Actions_ I ticked _Publish JUnit test result report_ then entered a comma-separated set of paths to the XML reports generated by each build step. For example, the _Springcache_ plugin has the following reports configured:

------------------------------------------------------------------------------------------------------------------------------------------
target/test-reports/*.xml,test/projects/springcache-test/target/test-reports/*.xml,test/projects/content-caching/target/test-reports/*.xml
------------------------------------------------------------------------------------------------------------------------------------------

That's picking up the root plugin's unit test reports and the reports generated by the _springcache-test_ and _content-caching_ test applications. Hudson does a good job of merging these together into a unified test report.

[[running-tests-that-need-a-browser]]
Running tests that need a browser
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Some of my tests use _Selenium RC_ which drives a real browser. Given that Hudson is running on a headless box I had to get the display exported to a box with an X Windows environment.

[[still-to-do]]
Still to do
~~~~~~~~~~~

Right now all the plugins are building against Grails 1.2.1 only so the next task is to set up parallel builds using Grails 1.3-RC1. Ideally I would like to use Hudson's multi-configuration project capability to do that but I haven't had a chance to look into it yet. I'd also like to use Gradle to build the various project with one build step but I'd lose the convenience in switching Grails versions that the Hudson Grails plugin gives me.
